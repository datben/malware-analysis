#include "stdafx.h"
#include <iostream>
#include "Windows.h"
#include <winternl.h>

// todo: explore custom debugger cc
// aleas en fonction de l'heure et input
// lire et stocker l'input de facon impr√©visible avec des push par ex
// utiliser ror ou rol
// xor .... xor
// mettre des nop partout
// essayer call recursif sur main
// run multiple thread
// casser la machine si debug ou wrong input

// if doit etre plus chelou que le else

// Luc : debug + if
// Ben : wrong input + else

using namespace std;

__declspec(noinline) PPEB f(){
	if (IsDebuggerPresent()){ cout << "Debugged 1" << endl; }
	BOOL res;
	CheckRemoteDebuggerPresent(GetCurrentProcess(), &res);
	if (res){ cout << "Debugged 2" << endl; }
	PPEB ppeb;
	__asm{
		mov eax, fs:[0x30]
		mov ppeb, eax
	}
	return ppeb;
}

int _tmain(int argc, _TCHAR* argv[])
{
	PPEB ppeb = f();
	printf("PEB.BeingDebugged: %d\n", ppeb->BeingDebugged);

	char input[32];
	cout << "Enter your input : ";
	cin >> input;

	if (false){
		__asm{
			nop
			nop
		}
		printf("You found the really secret key \n");

	} else{
		cout << input << endl;
	
	}
	while(1);
	return 0;
}

